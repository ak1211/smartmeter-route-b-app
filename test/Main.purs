module Test.Main
  ( main
  , parseFrameTest
  ) where

import Prelude
import Bp35a1 (ERXUDP(..), Responce(..))
import Bp35a1 as Bp35a1
import Data.ArrayBuffer.Builder (putUint8)
import Data.ArrayBuffer.Builder as Builder
import Data.ArrayBuffer.DataView as DataView
import Data.Either (either)
import Data.Foldable (foldM, traverse_)
import Data.Maybe (Maybe(..))
import EchonetLite as EchonetLite
import Effect (Effect)
import Effect.Class.Console (logShow)

showProperty :: EchonetLite.Property -> Effect Unit
showProperty p = logShow (EchonetLite.toStringWhmProperty <$> EchonetLite.makeSmartWhmProperty p)

parseFrameTest :: { responce :: Responce, rest :: Array Char } -> Effect Unit
parseFrameTest { responce: ResERXUDP (ERXUDP e), rest: _ } = do
  echonetliteframe <-
    Builder.execPut do
      foldM (\_ x -> putUint8 x) mempty e.payload
  p <- EchonetLite.parseEchonetLiteFrame (DataView.whole echonetliteframe)
  --  logShow p
  either mempty (\x -> traverse_ showProperty x.props) p

parseFrameTest _ = mempty

inputs :: Array String
inputs =
  [ "ERXUDP FE80:0000:0000:0000:0000:0000:0000:0000 FE80:0000:0000:0000:1234:5678:1234:5678 0E1A 0E1A 1234567812345678 1 0019 10812EDB02880105FF017301EA0B07E7030D001E000007A3F8"
  , "ERXUDP FE80:0000:0000:0000:0000:0000:0000:0000 FE80:0000:0000:0000:1234:5678:1234:5678 0E1A 0E1A 1234567812345678 1 0019 10812EDB02880105FF017301EB0B07E7030D001E000007A3F8"
  , "ERXUDP FE80:0000:0000:0000:0000:0000:0000:0000 FE80:0000:0000:0000:1234:5678:1234:5678 0E1A 0E1A 1234567812345678 1 0012 1081000102880105FF017201E704000001D4"
  , "ERXUDP FE80:0000:0000:0000:0000:0000:0000:0000 FE80:0000:0000:0000:1234:5678:1234:5678 0E1A 0E1A 1234567812345678 1 000F 1081000102880105FF017201800130"
  , "ERXUDP FE80:0000:0000:0000:0000:0000:0000:0000 FE80:0000:0000:0000:1234:5678:1234:5678 0E1A 0E1A 1234567812345678 1 000E 1081000102880105FF015201D300"
  , "ERXUDP FE80:0000:0000:0000:0000:0000:0000:0000 FE80:0000:0000:0000:1234:5678:1234:5678 0E1A 0E1A 1234567812345678 1 000F 1081000102880105FF017201D70107"
  , "ERXUDP FE80:0000:0000:0000:0000:0000:0000:0000 FE80:0000:0000:0000:1234:5678:1234:5678 0E1A 0E1A 1234567812345678 1 0012 1081000102880105FF017201E00400180ACF"
  , "ERXUDP FE80:0000:0000:0000:0000:0000:0000:0000 FE80:0000:0000:0000:1234:5678:1234:5678 0E1A 0E1A 1234567812345678 1 000F 1081000102880105FF017201E10102"
  , "ERXUDP FE80:0000:0000:0000:0000:0000:0000:0000 FE80:0000:0000:0000:1234:5678:1234:5678 0E1A 0E1A 1234567812345678 1 00D0 1081000102880105FF017201E2C20000001807A4001807B8001807CB001807D9001807DC001807DF001807E3001807E7001807EA001807EE001807F2001807F6001807FC0018081100180833001808450018085E0018087700180899001808AB001808C9001808FE001809360018096000180988001809910018099B001809B5001809CF001809DC001809EF00180A0900180A2B00180A5600180A6900180A7C00180A9900180AB500180AC5FFFFFFFEFFFFFFFEFFFFFFFEFFFFFFFEFFFFFFFEFFFFFFFEFFFFFFFEFFFFFFFEFFFFFFFE"
  , "ERXUDP FE80:0000:0000:0000:0000:0000:0000:0000 FE80:0000:0000:0000:1234:5678:1234:5678 0E1A 0E1A 1234567812345678 1 000F 1081000102880105FF017201E50100"
  , "ERXUDP FE80:0000:0000:0000:0000:0000:0000:0000 FE80:0000:0000:0000:1234:5678:1234:5678 0E1A 0E1A 1234567812345678 1 0012 1081000102880105FF017201E7040000011C"
  , "ERXUDP FE80:0000:0000:0000:0000:0000:0000:0000 FE80:0000:0000:0000:1234:5678:1234:5678 0E1A 0E1A 1234567812345678 1 0012 1081000102880105FF017201E804000F0011"
  ]

main :: Effect Unit
main = traverse_ go inputs
  where
  go x = do
    resp <- Bp35a1.parseResponce' Nothing x
    --    logShow resp
    either mempty parseFrameTest resp
